<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BetFriends - Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { dark: '#0f172a', card: '#1e293b', neonGreen: '#10b981', neonPurple: '#8b5cf6', danger: '#ef4444', gold: '#fbbf24' },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        .app-view { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .scroll-area { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; min-height: 0; padding-bottom: 80px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .native-toast { transform: translateY(-150%); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .native-toast.show { transform: translateY(0); }
        .neon-input, .neon-select { background: #334155; border: 1px solid #475569; color: white; transition: all 0.3s; }
        .neon-input:focus, .neon-select:focus { border-color: #8b5cf6; box-shadow: 0 0 8px rgba(139, 92, 246, 0.3); outline: none; }
        .avatar-circle { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background-color: #334155; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #94a3b8; font-size: 14px; border: 2px solid #1e293b; overflow: hidden; }
        .avatar-xl { width: 120px; height: 120px; font-size: 40px; border-width: 4px; }
        .avatar-sm { width: 24px; height: 24px; font-size: 10px; border-width: 1px; }
        details > summary { list-style: none; } details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body>

    <div id="modal-fullscreen-image" class="hidden fixed inset-0 bg-black z-[100] flex items-center justify-center fade-in" onclick="document.getElementById('modal-fullscreen-image').classList.add('hidden')">
        <img id="fullscreen-image-src" src="" class="max-w-full max-h-full object-contain p-2">
        <button class="absolute top-6 right-6 text-white bg-black/50 rounded-full w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>

    <div id="native-notification" class="native-toast fixed top-4 left-4 right-4 bg-slate-800/95 backdrop-blur-md border border-slate-600 rounded-2xl shadow-2xl z-[90] flex items-center gap-3 p-3 pointer-events-auto cursor-pointer" onclick="app.handleNotificationClick()">
        <div class="bg-neonPurple w-10 h-10 rounded-xl flex items-center justify-center text-white text-lg shrink-0"><i class="fa-solid fa-bell"></i></div>
        <div class="flex-1 min-w-0"><h4 class="text-xs font-bold text-slate-300 uppercase">BetFriends</h4><p id="native-notification-text" class="text-sm text-white font-medium truncate">...</p></div>
    </div>

    <div id="view-login" class="hidden app-view justify-center items-center p-6 bg-dark absolute inset-0 z-50">
        <div class="mb-8 text-center">
            <img src="logo.png" class="h-24 w-auto mx-auto mb-4 animate-bounce" alt="Logo">
            <h1 class="text-4xl font-bold tracking-tight text-white">Bet<span class="text-neonGreen">Friends</span></h1>
            <p class="text-slate-400 mt-2">Sincronizado en la Nube ‚òÅÔ∏è</p>
        </div>
        <div class="w-full max-w-sm bg-card p-6 rounded-2xl border border-slate-700 shadow-xl">
            <h2 id="auth-title" class="text-xl font-bold text-white mb-4 text-center">Iniciar Sesi√≥n</h2>
            <div class="space-y-4">
                <div><label class="block text-xs uppercase font-bold text-slate-400 mb-1">Usuario</label><input type="text" id="auth-user" class="neon-input w-full p-3 rounded-lg" placeholder="Ej: Alex"></div>
                <div><label class="block text-xs uppercase font-bold text-slate-400 mb-1">Contrase√±a</label><input type="password" id="auth-pass" class="neon-input w-full p-3 rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button id="btn-auth-action" onclick="app.submitAuth()" class="w-full bg-neonPurple hover:bg-violet-600 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95 mt-2">ENTRAR</button>
            </div>
            <div class="mt-4 text-center"><p class="text-xs text-slate-400"><span id="auth-toggle-text">¬øNo tienes cuenta?</span><button id="auth-toggle-btn" onclick="app.toggleAuthMode()" class="text-neonGreen font-bold hover:underline ml-1">Reg√≠strate aqu√≠</button></p></div>
        </div>
    </div>

    <div id="view-leagues" class="hidden app-view bg-dark absolute inset-0 z-40">
        <div class="p-6 pt-10 shrink-0">
            <div class="flex justify-between items-center mb-6"><div><h2 class="text-2xl font-bold text-white">Mis Ligas</h2><p class="text-slate-400 text-sm">Hola, <span id="league-username" class="text-neonGreen font-bold">User</span></p></div><button onclick="app.logout()" class="text-slate-500 hover:text-white"><i class="fa-solid fa-right-from-bracket"></i></button></div>
            <div class="grid grid-cols-2 gap-3 mb-6"><button onclick="app.openModal('create-league')" class="bg-neonPurple/10 border border-neonPurple text-neonPurple p-4 rounded-xl font-bold text-sm hover:bg-neonPurple hover:text-white transition"><i class="fa-solid fa-plus mb-1 block text-xl"></i> Crear Liga</button><button onclick="app.openModal('join-league')" class="bg-neonGreen/10 border border-neonGreen text-neonGreen p-4 rounded-xl font-bold text-sm hover:bg-neonGreen hover:text-dark transition"><i class="fa-solid fa-ticket mb-1 block text-xl"></i> Unirse</button></div>
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Tus Grupos (Nube)</h3>
        </div>
        <div id="leagues-list" class="scroll-area px-6 space-y-3"><div class="text-center text-slate-500 py-4"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><p>Cargando ligas...</p></div></div>
    </div>

    <div id="view-dashboard" class="hidden app-view bg-dark absolute inset-0 z-30">
        <header class="bg-card p-4 flex justify-between items-center shadow-md z-10 border-b border-slate-700 shrink-0">
            <div class="flex items-center gap-3"><button onclick="app.exitLeague()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button><div class="flex items-center gap-2 cursor-pointer" onclick="app.openProfileModal()"><div id="dash-my-avatar" class="avatar-circle border-neonPurple"><span>YO</span></div><div><h2 class="font-bold text-sm text-white leading-tight" id="dash-my-nickname">Nombre</h2><div class="flex items-center gap-1 text-neonGreen text-xs"><i class="fa-solid fa-coins"></i><span id="dash-balance" class="font-bold text-base">0</span></div></div></div></div>
            <div class="flex gap-2 items-center"><button id="btn-header-daily" onclick="app.claimDailyBonus()" class="hidden px-3 py-1 rounded-full text-[10px] font-bold items-center gap-1 border border-white/10"></button><button id="header-bell-btn" onclick="app.openNotificationsModal()" class="relative text-slate-400 bg-slate-800 p-2 rounded-full w-8 h-8 flex items-center justify-center hover:bg-slate-700"><i class="fa-solid fa-bell"></i><span id="header-bell-badge" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-danger rounded-full border-2 border-dark animate-pulse"></span></button><button onclick="app.openLeagueSettings()" class="text-slate-400 bg-slate-800 p-2 rounded-full w-8 h-8 flex items-center justify-center hover:bg-slate-700"><i class="fa-solid fa-gear"></i></button><button onclick="app.showRanking()" class="text-gold bg-gold/10 px-3 py-1 rounded-full text-xs font-bold w-8 h-8 flex items-center justify-center hover:bg-gold/20"><i class="fa-solid fa-trophy"></i></button></div>
        </header>
        <main class="scroll-area p-4 space-y-6">
            <div class="bg-slate-800/50 p-3 rounded-lg flex justify-between items-center border border-slate-700/50"><div><span class="text-[10px] text-slate-500 uppercase block">Est√°s en la liga</span><span id="dash-league-name" class="font-bold text-white text-sm">...</span></div><button onclick="app.copyCode()" class="text-neonPurple font-mono font-bold text-sm tracking-widest flex items-center gap-2 bg-neonPurple/10 px-2 py-1 rounded cursor-pointer hover:bg-neonPurple/20"><span id="dash-league-code">...</span> <i class="fa-regular fa-copy"></i></button></div>
            <div onclick="app.openCreateBetModal()" class="bg-gradient-to-r from-violet-900 to-fuchsia-900 p-5 rounded-2xl shadow-lg relative overflow-hidden cursor-pointer active:scale-95 transition"><div class="absolute -right-4 -bottom-4 opacity-20 text-8xl text-white"><i class="fa-solid fa-plus"></i></div><h3 class="text-lg font-bold mb-1 text-white">Nueva Apuesta</h3><p class="text-slate-200 text-xs opacity-80">Reta a los miembros</p></div>
            <div class="flex gap-2 overflow-x-auto py-1 shrink-0"><button onclick="app.filterBets('active')" class="filter-btn active px-4 py-1 rounded-full text-xs font-bold border border-slate-600 bg-neonPurple text-white">Activas</button><button onclick="app.filterBets('pending')" class="filter-btn px-4 py-1 rounded-full text-xs font-bold border border-slate-600 text-slate-400 relative">Pendientes <span id="badge-pending" class="hidden absolute -top-1 -right-1 bg-danger text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full border border-dark">0</span></button><button onclick="app.filterBets('resolved')" class="filter-btn px-4 py-1 rounded-full text-xs font-bold border border-slate-600 text-slate-400">Historial</button></div>
            <div id="bets-container" class="space-y-4"></div>
        </main>
    </div>

    <div id="modal-create-league" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-card w-full max-w-sm rounded-2xl p-6 border border-slate-700 slide-up"><h3 class="text-lg font-bold text-white mb-4">Nueva Liga</h3><div class="mb-4"><label class="text-xs text-slate-400 uppercase font-bold">Nombre</label><input type="text" id="new-league-name" class="neon-input w-full p-3 rounded-lg mt-1" placeholder="Ej: La Liga de los Reyes"></div><div class="flex justify-between items-center mb-4"><div><label class="text-sm font-bold text-white block">Saldo Inicial</label></div><input type="number" id="conf-start-balance" class="neon-input w-20 p-1 text-center font-bold text-neonGreen text-sm rounded" value="1000"></div><div class="grid grid-cols-2 gap-3"><button onclick="app.closeModals()" class="bg-slate-700 text-slate-300 py-3 rounded-lg font-bold text-sm">Cancelar</button><button onclick="app.createLeague()" class="bg-neonPurple text-white py-3 rounded-lg font-bold text-sm shadow-lg">Crear</button></div></div></div>
    <div id="modal-join-league" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-card w-full max-w-sm rounded-2xl p-6 border border-slate-700 slide-up"><h3 class="text-lg font-bold text-white mb-4">Unirse a Liga</h3><label class="text-xs text-slate-400 uppercase font-bold">C√≥digo</label><input type="text" id="join-league-code" class="neon-input w-full p-3 rounded-lg mt-1 mb-4 font-mono text-center uppercase tracking-widest" placeholder="ABCD12"><div class="grid grid-cols-2 gap-3"><button onclick="app.closeModals()" class="bg-slate-700 text-slate-300 py-3 rounded-lg font-bold text-sm">Cancelar</button><button onclick="app.joinLeague()" class="bg-neonGreen text-dark py-3 rounded-lg font-bold text-sm shadow-lg">Entrar</button></div></div></div>
    <div id="modal-create-bet" class="hidden fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm"><div class="bg-card w-full sm:w-[30rem] rounded-t-2xl sm:rounded-2xl flex flex-col border-t border-slate-700 slide-up p-6 max-h-[90vh]"><h3 class="text-lg font-bold text-white mb-4">Nueva Apuesta</h3><div class="scroll-area space-y-4"><div><label class="text-xs text-slate-400 uppercase font-bold">Tipo</label><select id="create-type" onchange="app.toggleCreateFields()" class="neon-select w-full p-3 rounded-lg mt-1 bg-slate-800 text-white font-bold"><option value="duel">‚öîÔ∏è Duelo (1 vs 1)</option><option value="group">üí∞ Bote General</option><option value="custom" selected>üìä Porra</option><option value="bank" id="opt-bank">üé∞ Contra la Banca</option></select></div><div><label class="text-xs text-slate-400 uppercase font-bold">T√≠tulo</label><input type="text" id="create-title" class="neon-input w-full p-3 rounded-lg mt-1" placeholder="Ej: Ganador del Partido"></div><div><label class="text-xs text-slate-400 uppercase font-bold">Entrada</label><input type="number" id="create-amount" class="neon-input w-full p-3 rounded-lg mt-1 text-neonGreen font-bold" placeholder="50"></div><div id="field-options" class="block"><div class="flex justify-between items-center mb-2"><label class="text-xs text-slate-400 uppercase font-bold">Opciones</label><button onclick="app.addOptionInput()" class="text-neonPurple text-xs font-bold">+ A√±adir</button></div><div id="options-list" class="space-y-2"></div></div><button onclick="app.createBet()" class="w-full bg-neonPurple py-4 rounded-xl font-bold text-white shadow-lg mt-4">CREAR</button><button onclick="app.closeModals()" class="w-full text-slate-400 py-2 text-sm">Cancelar</button></div></div></div>
    
    <div id="modal-action" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-card w-full max-w-sm rounded-2xl p-6 border border-slate-700 slide-up flex flex-col max-h-[80vh]"><h3 id="action-title" class="text-lg font-bold text-white mb-2">Acci√≥n</h3><p id="action-content" class="text-sm text-slate-400 mb-4">Detalles</p><div id="action-bet-input-container" class="hidden mb-4 bg-slate-800 p-3 rounded-lg border border-slate-600"><label class="text-[10px] text-slate-400 uppercase font-bold block mb-1">Tu Apuesta</label><input type="number" id="action-bet-amount" class="neon-input w-full p-2 rounded text-neonGreen font-bold font-mono text-lg" placeholder="0"></div><div id="action-dynamic-list" class="scroll-area mb-4 border-t border-b border-slate-700/50 py-2"></div><div class="grid grid-cols-2 gap-3"><button onclick="app.closeModals()" class="bg-slate-700 text-slate-300 py-3 rounded-lg font-bold text-sm">Cerrar</button><button id="action-confirm-btn" class="bg-neonGreen text-dark py-3 rounded-lg font-bold text-sm">Confirmar</button></div></div></div>
    <div id="modal-profile" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-card w-full max-w-sm rounded-2xl p-6 border border-slate-700 slide-up text-center"><h3 class="text-lg font-bold text-white mb-6">Perfil</h3><div class="relative inline-block mb-6"><div id="profile-preview" class="avatar-circle avatar-xl border-neonPurple mx-auto"></div><label for="file-upload" class="absolute bottom-1 right-1 bg-neonPurple text-white rounded-full w-10 h-10 flex items-center justify-center cursor-pointer shadow-lg"><i class="fa-solid fa-camera text-sm"></i></label><input id="file-upload" type="file" accept="image/*" class="hidden" onchange="app.handleImageUpload(this)"></div><input type="text" id="profile-nickname" class="neon-input w-full p-3 rounded-lg mt-1 text-center font-bold"><div class="grid grid-cols-2 gap-3 mt-4"><button onclick="app.closeModals()" class="bg-slate-700 text-slate-300 py-3 rounded-lg font-bold text-sm">Cancelar</button><button onclick="app.saveProfile()" class="bg-neonGreen text-dark py-3 rounded-lg font-bold text-sm shadow-lg">Guardar</button></div></div></div>
    <div id="modal-ranking" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-card w-full max-w-sm rounded-2xl p-6 border border-slate-700 slide-up max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gold"><i class="fa-solid fa-crown mr-2"></i>Ranking</h3><button onclick="app.closeModals()" class="text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button></div><div id="ranking-list" class="scroll-area pr-2"></div></div></div>
    <div id="modal-notifications" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-end sm:items-center justify-center backdrop-blur-sm"><div class="bg-card w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 border-t border-slate-700 slide-up max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-white">Notificaciones</h3><button onclick="app.closeModals()" class="text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button></div><div id="notifications-list" class="scroll-area space-y-3"></div></div></div>
    <div id="modal-confirm" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-card w-full max-w-sm rounded-2xl p-6 border border-slate-700 slide-up text-center"><i class="fa-solid fa-triangle-exclamation text-4xl text-danger mb-4"></i><h3 class="text-lg font-bold text-white mb-2">¬øSeguro?</h3><p id="confirm-msg" class="text-sm text-slate-400 mb-6">Irreversible.</p><div class="grid grid-cols-2 gap-3"><button onclick="app.closeModals()" class="bg-slate-700 text-slate-300 py-3 rounded-lg font-bold text-sm">No</button><button onclick="app.confirmYes()" class="bg-danger text-white py-3 rounded-lg font-bold text-sm shadow-lg">S√≠</button></div></div></div>
    <div id="modal-league-settings" class="hidden fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-card w-full max-w-sm rounded-2xl p-6 border border-slate-700 slide-up"><h3 class="text-lg font-bold text-white mb-4">Ajustes</h3><div class="space-y-3"><button onclick="app.deleteLeague()" class="w-full bg-danger/10 border border-danger text-danger py-3 rounded-xl font-bold text-sm">Eliminar Liga</button><button onclick="app.leaveLeague()" class="w-full bg-slate-800 border border-slate-600 text-slate-300 py-3 rounded-xl font-bold text-sm">Salir de Liga</button></div><button onclick="app.closeModals()" class="w-full text-slate-400 py-3 mt-4">Cerrar</button></div></div>

    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-slate-600 text-white px-4 py-2 rounded-full shadow-2xl z-[100] transition-all duration-300 opacity-0 pointer-events-none flex items-center gap-2 min-w-max"><i class="fa-solid fa-info-circle text-neonPurple"></i><span id="toast-msg" class="font-medium text-xs">Info</span></div>

    <script>
        // CONFIGURACION FIREBASE REAL
        const firebaseConfig = {
            apiKey: "AIzaSyBFwzQUXNkix4u0J9asPte8OvVQph_FfPY",
            authDomain: "betfriends-81bcc.firebaseapp.com",
            projectId: "betfriends-81bcc",
            storageBucket: "betfriends-81bcc.firebasestorage.app",
            messagingSenderId: "618594781062",
            appId: "1:618594781062:web:f29996182529ad9bc04e07"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        console.log("üî• CONECTADO A NUBE REAL");

        const app = {
            data: { user: null, leagues: [], currentLeagueId: null, filter: 'active', inviteMode: 'public', selectedInvites: [], tempAvatar: null },
            pendingCallback: null,
            authMode: 'login',
            unsubscribeLeagues: null, // Para dejar de escuchar si sales

            init() {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        this.data.user = user.email.split('@')[0]; // Usamos parte del email como ID visual
                        // Buscar perfil real en BD
                        db.collection('users').doc(user.uid).get().then(doc => {
                           if(doc.exists && doc.data().nickname) this.data.user = doc.data().nickname;
                           this.performLoginSuccess();
                        }).catch(()=>this.performLoginSuccess());
                    } else {
                        document.getElementById('view-login').classList.remove('hidden');
                        document.getElementById('view-login').classList.add('flex');
                    }
                });
            },

            performLoginSuccess() {
                document.getElementById('view-login').classList.remove('flex');
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('auth-user').value = ''; 
                document.getElementById('auth-pass').value = '';
                this.showLeaguesView();
                this.initRealtimeLeagues(); // <--- AQU√ç EST√Å LA MAGIA
            },

            // ESCUCHAR CAMBIOS EN LA NUBE
            initRealtimeLeagues() {
                if(this.unsubscribeLeagues) this.unsubscribeLeagues();
                // Escuchamos TODAS las ligas (podr√≠amos filtrar, pero para empezar est√° bien)
                this.unsubscribeLeagues = db.collection('leagues').onSnapshot((snapshot) => {
                    const cloudLeagues = [];
                    snapshot.forEach((doc) => {
                        cloudLeagues.push(doc.data());
                    });
                    this.data.leagues = cloudLeagues;
                    console.log("‚òÅÔ∏è Ligas actualizadas desde la nube:", cloudLeagues.length);
                    // Si estamos viendo ligas, refrescar lista
                    if(!document.getElementById('view-leagues').classList.contains('hidden')) this.renderLeaguesList();
                    // Si estamos dentro de una liga, refrescar dashboard
                    if(this.data.currentLeagueId) this.renderDashboard();
                    
                    this.checkAndNotify();
                });
            },

            // GUARDAR EN LA NUBE (REEMPLAZA A LOCALSTORAGE)
            saveLeagueToCloud(league) {
                // Guardamos la liga completa en Firestore usando su ID como nombre de documento
                db.collection('leagues').doc(league.id.toString()).set(league)
                .then(() => console.log("‚úÖ Liga guardada en nube"))
                .catch((e) => this.toast("Error guardando: " + e.message, "error"));
            },

            // --- AUTH ---
            async submitAuth() {
                const email = document.getElementById('auth-user').value.trim(); 
                const pass = document.getElementById('auth-pass').value.trim();
                if(!email || !pass) return this.toast("Faltan datos", "error");
                let finalEmail = email.includes('@') ? email : email + "@betfriends.com";
                
                this.toast("Conectando...", "info");
                try {
                    if (this.authMode === 'register') {
                        const cred = await auth.createUserWithEmailAndPassword(finalEmail, pass);
                        await db.collection("users").doc(cred.user.uid).set({ nickname: email.split('@')[0], createdAt: new Date() });
                        this.toast("¬°Cuenta creada!");
                    } else {
                        await auth.signInWithEmailAndPassword(finalEmail, pass);
                        this.toast("Sesi√≥n iniciada");
                    }
                } catch (e) {
                    let msg = e.message;
                    if (e.code === 'auth/wrong-password') msg = "Contrase√±a mal";
                    if (e.code === 'auth/user-not-found') msg = "Usuario no existe";
                    if (e.code === 'auth/weak-password') msg = "Contrase√±a corta";
                    this.toast(msg, "error");
                }
            },
            logout() { auth.signOut().then(() => location.reload()); },
            toggleAuthMode() { 
                this.authMode = this.authMode === 'login' ? 'register' : 'login';
                document.getElementById('auth-title').innerText = this.authMode==='login'?"Iniciar Sesi√≥n":"Crear Cuenta";
                document.getElementById('btn-auth-action').innerText = this.authMode==='login'?"ENTRAR":"CREAR";
                document.getElementById('auth-toggle-text').innerText = this.authMode==='login'?"¬øNo tienes cuenta?":"¬øYa tienes?";
                document.getElementById('auth-toggle-btn').innerText = this.authMode==='login'?"Reg√≠strate":"Entra";
            },

            // --- LIGAS ---
            createLeague() { 
                const n = document.getElementById('new-league-name').value.trim();
                if(!n) return this.toast("Pon nombre","error");
                const l = {
                    id: Date.now(), 
                    name: n, 
                    code: Math.random().toString(36).substring(2,8).toUpperCase(), 
                    creator: this.data.user,
                    members: {}, 
                    bets: []
                };
                l.members[this.data.user] = { balance: 1000, nickname: this.data.user, avatar: null };
                
                // GUARDAR EN CLOUD
                this.saveLeagueToCloud(l);
                this.closeModals();
                this.toast("Liga creada en la nube");
            },
            joinLeague() { 
                const c = document.getElementById('join-league-code').value.trim().toUpperCase();
                // Buscar en la lista local (que viene de la nube)
                const l = this.data.leagues.find(x => x.code === c);
                if(!l) return this.toast("No existe","error");
                if(l.members[this.data.user]) return this.toast("Ya est√°s dentro","error");
                
                l.members[this.data.user] = { balance: 1000, nickname: this.data.user, avatar: null };
                this.saveLeagueToCloud(l); // ACTUALIZAR EN CLOUD
                this.closeModals();
                this.toast("Unido correctamente");
            },

            // --- APUESTAS (AHORA ACTUALIZAN LA NUBE) ---
            createBet() { 
                const l=this.getCurrentLeague(); 
                const t=document.getElementById('create-type').value; 
                const ti=document.getElementById('create-title').value.trim(); 
                let a=t==='bank'?0:parseInt(document.getElementById('create-amount').value); 
                if(!ti) return this.toast("Falta t√≠tulo","error"); 
                
                let o=[], od={}; 
                if(t==='custom'||t==='bank'){ 
                    for(let r of document.getElementById('options-list').children){ 
                        const n=r.querySelector('.option-name').value.trim(); 
                        const v=r.querySelector('.option-odd').value; 
                        if(n){ o.push(n); if(t==='bank') od[n]=parseFloat(v)||1.5; } 
                    } 
                    if(o.length<2) return this.toast("M√≠nimo 2 opciones","error"); 
                }
                
                if(t!=='bank'){ 
                    if(l.members[this.data.user].balance < a) return this.toast("Sin saldo","error");
                    l.members[this.data.user].balance -= a; 
                }

                const b = {
                    id: Date.now(), type:t, creator:this.data.user, title:ti, amount:a, pot:t==='bank'?0:a,
                    participants:t==='bank'?[]:[this.data.user], status:'active', options:o, odds:od, selections:{}, timestamp:new Date().toLocaleDateString()
                };
                l.bets.unshift(b);
                
                this.saveLeagueToCloud(l); // GUARDAR
                this.closeModals();
                this.toast("Apuesta publicada");
            },
            
            // --- UPDATERS ---
            updateBet(action, betId, payload) {
                const l = this.getCurrentLeague();
                const b = l.bets.find(x => x.id === betId);
                if(!b) return;

                if(action === 'join') {
                    const cost = b.type==='bank' ? payload.amount : b.amount;
                    if(l.members[this.data.user].balance < cost) return this.toast("Sin saldo","error");
                    l.members[this.data.user].balance -= cost;
                    b.pot += cost;
                    if(!b.participants.includes(this.data.user)) b.participants.push(this.data.user);
                    
                    if(b.type==='bank') b.selections[this.data.user] = {option: payload.selection, wager: cost, odd: payload.odd};
                    else b.selections[this.data.user] = payload.selection;
                }
                else if(action === 'resolve') {
                    b.status = 'resolved'; b.winner = payload.winner; b.winningOption = payload.winner; b.resolvedAt = Date.now();
                    // Logica pagos
                    if(b.type==='bank') {
                        Object.keys(b.selections).forEach(u=>{
                            const r=b.selections[u];
                            if(r && r.option===payload.winner && l.members[u]) l.members[u].balance += Math.floor(r.wager*r.odd);
                        });
                    } else {
                        // Logica standard
                        let winners = [];
                        if(b.type==='custom') winners = Object.entries(b.selections).filter(([u,s])=>s===payload.winner).map(([u])=>u);
                        else if(l.members[payload.winner]) winners = [payload.winner];
                        
                        if(winners.length > 0) {
                            const prize = Math.floor(b.pot / winners.length);
                            winners.forEach(w => { if(l.members[w]) l.members[w].balance += prize; });
                        } else {
                            l.members[b.creator].balance += b.pot; // Devolver
                        }
                    }
                }
                else if(action === 'cancel') {
                    // Devolver dinero
                     if (b.type === 'bank') {
                        if (b.selections) Object.keys(b.selections).forEach(u => { if (l.members[u]) l.members[u].balance += b.selections[u].wager; });
                    } else {
                        b.participants.forEach(p => { if (l.members[p]) l.members[p].balance += b.amount; });
                    }
                    l.bets = l.bets.filter(x => x.id !== betId);
                }

                this.saveLeagueToCloud(l); // GUARDAR
                this.closeModals();
                this.toast("Actualizado");
            },

            // --- UI HELPERS ---
            showLeaguesView() { document.querySelectorAll('.app-view').forEach(e=>e.classList.add('hidden')); document.getElementById('view-leagues').classList.remove('hidden'); document.getElementById('view-leagues').classList.add('flex'); document.getElementById('league-username').innerText=this.data.user; this.renderLeaguesList(); },
            selectLeague(id) { this.data.currentLeagueId=id; document.querySelectorAll('.app-view').forEach(e=>e.classList.add('hidden')); document.getElementById('view-dashboard').classList.remove('hidden'); document.getElementById('view-dashboard').classList.add('flex'); this.renderDashboard(); },
            getCurrentLeague() { return this.data.leagues.find(l=>l.id===this.data.currentLeagueId); },
            renderLeaguesList() {
                const el = document.getElementById('leagues-list'); el.innerHTML = '';
                const my = this.data.leagues.filter(x => x.members[this.data.user]);
                if (my.length === 0) { el.innerHTML = `<div class="text-center text-slate-500 py-4">No est√°s en ninguna liga.</div>`; return; }
                my.forEach(x => {
                    const m = x.members[this.data.user] || {balance:0};
                    el.innerHTML += `<div class="bg-card p-4 rounded-xl border border-slate-700 flex justify-between items-center cursor-pointer mb-3" onclick="app.selectLeague(${x.id})"><div><h4 class="font-bold text-white text-lg">${x.name}</h4><p class="text-xs text-slate-400">C√≥digo: ${x.code}</p></div><div class="text-right"><div class="text-neonGreen font-mono font-bold text-xl">${m.balance}</div></div></div>`;
                });
            },
            renderDashboard() {
                const l=this.getCurrentLeague(); if(!l) return;
                const m=l.members[this.data.user];
                document.getElementById('dash-league-name').innerText=l.name; document.getElementById('dash-league-code').innerText=l.code;
                document.getElementById('dash-balance').innerText=m.balance; document.getElementById('dash-my-nickname').innerText=m.nickname;
                document.getElementById('dash-my-avatar').innerHTML=m.avatar?`<img src="${m.avatar}" class="w-full h-full object-cover rounded-full">`:`<span>${m.nickname.substring(0,2).toUpperCase()}</span>`;
                
                const con=document.getElementById('bets-container'); con.innerHTML='';
                const fil=l.bets.filter(b=>{
                    const ip=b.participants.includes(this.data.user); const ic=b.creator===this.data.user; const ir=b.status==='resolved';
                    if(this.data.filter==='active') return !ir && (ip||ic);
                    if(this.data.filter==='pending') return !ir && !ip && !ic; 
                    if(this.data.filter==='resolved') return ir;
                });
                if(fil.length===0) con.innerHTML=`<div class="text-center text-slate-500 py-10">Nada por aqu√≠.</div>`;
                fil.forEach(b=>this.renderBetCard(b,con,l));
            },
            // RENDER CARD SIMPLIFICADO
            renderBetCard(b,c,l) {
                const me=this.data.user; 
                let acts = '';
                if(this.data.filter==='active') {
                    if(b.creator===me) acts=`<button onclick="app.resolveBetModal(${b.id})" class="w-full border border-neonPurple text-neonPurple py-2 rounded text-xs font-bold mt-2">Resolver</button><button onclick="app.updateBet('cancel',${b.id})" class="w-full text-danger text-xs mt-2">Cancelar</button>`;
                    else acts=`<div class="text-center text-xs text-slate-500 mt-2">Est√°s participando</div>`;
                } else if(this.data.filter==='pending') {
                    acts=`<button onclick="app.joinBetModal(${b.id})" class="w-full bg-neonGreen text-dark py-2 rounded text-xs font-bold mt-2">Entrar (${b.amount})</button>`;
                } else {
                    acts=`<div class="text-center text-neonGreen font-bold text-xs mt-2">Ganador: ${b.winningOption}</div>`;
                }
                c.innerHTML+=`<div class="bg-card p-4 rounded-xl border border-slate-700 shadow-lg"><div class="flex justify-between"><div><h4 class="font-bold text-white text-sm">${b.title}</h4><p class="text-xs text-slate-500">${b.type}</p></div><div class="text-neonGreen font-bold">${b.pot}</div></div>${acts}</div>`;
            },
            
            // --- MODALES Y AUX ---
            joinBetModal(id) { 
                const l=this.getCurrentLeague(); const b=l.bets.find(x=>x.id===id); 
                document.getElementById('modal-action').classList.remove('hidden'); document.getElementById('action-title').innerText="Unirse"; 
                const lst=document.getElementById('action-dynamic-list'); lst.innerHTML=''; let s=null;
                if(b.type==='bank') {
                    document.getElementById('action-bet-input-container').classList.remove('hidden');
                    document.getElementById('action-content').innerText = "Elige opci√≥n y cantidad:";
                } else {
                    document.getElementById('action-bet-input-container').classList.add('hidden');
                    document.getElementById('action-content').innerText = "Entrada: "+b.amount;
                }
                (b.options||[]).forEach(o=>{ 
                    const d=document.createElement('div'); d.className="bg-slate-700 p-3 rounded mb-1 cursor-pointer hover:bg-slate-600"; 
                    d.innerText=b.type==='bank'?`${o} (x${b.odds[o]})`:o; 
                    d.onclick=()=>{ Array.from(lst.children).forEach(x=>x.classList.remove('border','border-neonGreen')); d.classList.add('border','border-neonGreen'); s=o; }; 
                    lst.appendChild(d); 
                });
                document.getElementById('action-confirm-btn').onclick=()=>{ 
                    const amt=b.type==='bank'?parseInt(document.getElementById('action-bet-amount').value):b.amount;
                    if(!s) return this.toast("Elige opci√≥n","error");
                    this.updateBet('join', id, {selection:s, amount:amt, odd:(b.odds?b.odds[s]:0)}); 
                };
            },
            resolveBetModal(id) {
                const l=this.getCurrentLeague(); const b=l.bets.find(x=>x.id===id);
                document.getElementById('modal-action').classList.remove('hidden'); document.getElementById('action-title').innerText="Resolver"; 
                document.getElementById('action-bet-input-container').classList.add('hidden');
                const lst=document.getElementById('action-dynamic-list'); lst.innerHTML='';
                const opts = b.type==='duel'||b.type==='group' ? b.participants : b.options;
                opts.forEach(o=>{
                    const btn=document.createElement('button'); btn.className="w-full bg-slate-700 p-2 rounded mb-1 text-left hover:bg-slate-600"; btn.innerText=o;
                    btn.onclick=()=>{ this.updateBet('resolve', id, {winner:o}); };
                    lst.appendChild(btn);
                });
            },
            saveProfile() {
                const l=this.getCurrentLeague(); 
                l.members[this.data.user].nickname = document.getElementById('profile-nickname').value;
                l.members[this.data.user].avatar = this.data.tempAvatar;
                this.saveLeagueToCloud(l); this.closeModals();
            },
            openModal(id) { document.getElementById(`modal-${id}`).classList.remove('hidden'); },
            closeModals() { document.querySelectorAll('[id^="modal-"]').forEach(el=>el.classList.add('hidden')); },
            toast(m,t='s') { const el=document.getElementById('toast'); el.querySelector('span').innerText=m; el.classList.remove('opacity-0'); setTimeout(()=>el.classList.add('opacity-0'),3000); },
            copyCode() { navigator.clipboard.writeText(document.getElementById('dash-league-code').innerText).then(()=>this.toast("Copiado")); },
            openProfileModal() { const m=this.getCurrentLeague().members[this.data.user]; document.getElementById('profile-nickname').value=m.nickname; this.data.tempAvatar=m.avatar; document.getElementById('profile-preview').innerHTML=m.avatar?`<img src="${m.avatar}" class="w-full h-full object-cover">`:''; this.openModal('profile'); },
            handleImageUpload(i) { if(i.files[0]){ const r=new FileReader(); r.onload=(e)=>{this.data.tempAvatar=e.target.result; document.getElementById('profile-preview').innerHTML=`<img src="${e.target.result}" class="w-full h-full object-cover">`;}; r.readAsDataURL(i.files[0]); } },
            checkAndNotify() {}, 
            addOptionInput() { const c=document.getElementById('options-list'); c.innerHTML+=`<div class="flex gap-2 mb-2"><input type="text" class="option-name neon-input flex-1 p-2 rounded text-sm" placeholder="Opci√≥n"><input type="number" class="option-odd neon-input w-20 p-2 rounded text-sm" placeholder="x1.5"></div>`; },
            toggleCreateFields() { const t=document.getElementById('create-type').value; document.getElementById('field-options').style.display=(t==='custom'||t==='bank')?'block':'none'; document.getElementById('opt-bank').style.display=this.getCurrentLeague().creator===this.data.user?'block':'none'; },
            deleteLeague() { if(confirm("¬øBorrar liga?")) { db.collection('leagues').doc(this.data.currentLeagueId.toString()).delete(); this.exitLeague(); } },
            leaveLeague() { if(confirm("¬øSalir?")) { const l=this.getCurrentLeague(); delete l.members[this.data.user]; this.saveLeagueToCloud(l); this.exitLeague(); } },
            exitLeague() { this.data.currentLeagueId=null; this.showLeaguesView(); }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>